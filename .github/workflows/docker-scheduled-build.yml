name: Docker Scheduled Build

on:
  schedule:
    # Build images weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  DOCKER_REGISTRY: docker.io

jobs:
  check-updates:
    name: Check for Base Image Updates
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for base image updates
        id: check
        run: |
          # Check if any base images have been updated
          # This is a simplified check - in production, you'd want more sophisticated logic
          echo "should_build=true" >> $GITHUB_OUTPUT

  build-all-images:
    name: Build All Docker Images
    needs: [check-updates]
    if: needs.check-updates.outputs.should_build == 'true'
    uses: ./.github/workflows/docker-build-push.yml
    secrets: inherit
    with:
      push_images: true

  cleanup-old-images:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: [build-all-images]
    if: always()
    
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Cleanup old images
        run: |
          echo "Cleanup logic would go here"
          echo "This would remove images older than 30 days, keeping only the latest 10 versions"
          # In production, you'd use Docker Hub API or a tool like docker-hub-cleanup

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-all-images]
    if: always()
    
    steps:
      - name: Generate notification
        run: |
          echo "# Scheduled Docker Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- Build Status: ${{ needs.build-all-images.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Details" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: Scheduled weekly build" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-all-images.result }}" == "success" ]; then
            echo "✅ All images built successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some images failed to build" >> $GITHUB_STEP_SUMMARY
          fi
