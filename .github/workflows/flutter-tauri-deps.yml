name: Flutter & Tauri Dependencies Update

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_flutter:
        description: 'Update Flutter dependencies'
        required: false
        default: true
        type: boolean
      update_tauri:
        description: 'Update Tauri dependencies'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  flutter-deps:
    name: Update Flutter Dependencies
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_flutter != 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
          channel: 'stable'

      - name: Get Flutter dependencies
        working-directory: hello-grpc-flutter
        run: flutter pub get

      - name: Update Flutter dependencies
        working-directory: hello-grpc-flutter
        run: |
          flutter pub upgrade --major-versions
          flutter pub get

      - name: Run Flutter tests
        working-directory: hello-grpc-flutter
        run: flutter test
        continue-on-error: true

      - name: Check for changes
        id: flutter-changes
        run: |
          if git diff --quiet hello-grpc-flutter/pubspec.lock; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Flutter PR
        if: steps.flutter-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "flutter: update dependencies to latest versions"
          title: "ðŸ”„ Update Flutter dependencies"
          body: |
            ## Flutter Dependencies Update
            
            This PR updates Flutter dependencies to their latest versions.
            
            ### Changes
            - Updated `pubspec.lock` with latest compatible versions
            - Ran `flutter pub upgrade --major-versions`
            
            ### Testing
            - âœ… Dependencies resolved successfully
            - âš ï¸ Tests may need review (check workflow logs)
            
            **Auto-generated by GitHub Actions**
          branch: flutter-deps-update
          base: main
          labels: |
            dependencies
            flutter
            automated

  tauri-deps:
    name: Update Tauri Dependencies
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_tauri != 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: hello-grpc-tauri/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            hello-grpc-tauri/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('hello-grpc-tauri/src-tauri/Cargo.lock') }}

      - name: Update npm dependencies
        working-directory: hello-grpc-tauri
        run: |
          npm update
          npm audit fix --force || true

      - name: Update Cargo dependencies
        working-directory: hello-grpc-tauri/src-tauri
        run: |
          cargo update
          cargo check

      - name: Build Tauri app (check compilation)
        working-directory: hello-grpc-tauri
        run: |
          npm run tauri build --debug
        continue-on-error: true

      - name: Check for changes
        id: tauri-changes
        run: |
          if git diff --quiet hello-grpc-tauri/package-lock.json hello-grpc-tauri/src-tauri/Cargo.lock; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Tauri PR
        if: steps.tauri-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "tauri: update frontend and backend dependencies"
          title: "ðŸ”„ Update Tauri dependencies"
          body: |
            ## Tauri Dependencies Update
            
            This PR updates both frontend (npm) and backend (Cargo) dependencies for the Tauri application.
            
            ### Changes
            - Updated `package-lock.json` with latest npm packages
            - Updated `Cargo.lock` with latest Rust crates
            - Ran security audit fixes where possible
            
            ### Testing
            - âœ… Dependencies resolved successfully
            - âš ï¸ Build check may need review (check workflow logs)
            
            **Auto-generated by GitHub Actions**
          branch: tauri-deps-update
          base: main
          labels: |
            dependencies
            tauri
            automated

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [flutter-deps, tauri-deps]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Flutter security audit
        working-directory: hello-grpc-flutter
        run: |
          flutter pub deps
          # Note: Flutter doesn't have a built-in security audit like npm
          echo "Flutter dependencies listed above"
        continue-on-error: true

      - name: Tauri npm security audit
        working-directory: hello-grpc-tauri
        run: |
          npm install
          npm audit --audit-level=moderate
        continue-on-error: true

      - name: Tauri Cargo security audit
        working-directory: hello-grpc-tauri/src-tauri
        run: |
          cargo audit
        continue-on-error: true

      - name: Create security report
        run: |
          echo "# Security Audit Report" > security-report.md
          echo "Generated on: $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "## Flutter Project" >> security-report.md
          echo "- Location: hello-grpc-flutter/" >> security-report.md
          echo "- No built-in security audit available" >> security-report.md
          echo "" >> security-report.md
          echo "## Tauri Project" >> security-report.md
          echo "- Frontend: hello-grpc-tauri/" >> security-report.md
          echo "- Backend: hello-grpc-tauri/src-tauri/" >> security-report.md
          echo "- Check workflow logs for detailed audit results" >> security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-report
          path: security-report.md